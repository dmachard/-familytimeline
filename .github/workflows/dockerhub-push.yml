name: Dockerhub

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      backend-version: ${{ steps.get_version_backend.outputs.version }}
      frontend-version: ${{ steps.get_version_frontend.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
  
      - name: Install dependencies for Backend and frontend
        run: npm run install

      - name: Get version from backend package.json
        id: get_version_backend
        run: echo "data=$(node -p "require('./backend-server/package.json').version")" >> $GITHUB_OUTPUT

      - name: Get version from frontend package.json
        id: get_version_frontend
        run: echo "version=$(node -p "require('./vuejs-client/package.json').version")" >> $GITHUB_OUTPUT

      - name: Build Docker image for Backend
        run: |
          docker build -t familytimeline-server:${{ steps.get_version_backend.outputs.version }} -f backend-server/Dockerfile backend-server

      - name: Build Docker image for Frontend
        run: |
          docker build -t familytimeline-client:${{ steps.get_version_frontend.outputs.version }} -f vuejs-client/Dockerfile vuejs-client

  push_server:
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.backend-version != ''
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Push Docker image for Backend to Docker Hub
        run: |
          docker tag familytimeline-server:${{ needs.build.outputs.backend-version }} ${{ secrets.DOCKER_USERNAME }}/familytimeline-server:${{ needs.build.outputs.backend-version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/familytimeline-server:${{ needs.build.outputs.backend-version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/familytimeline-server:latest

  push_client:
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.frontend-version != ''
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Push Docker image for Frontend to Docker Hub
        run: |
          docker tag familytimeline-client:${{ needs.build.outputs.frontend-version }} ${{ secrets.DOCKER_USERNAME }}/familytimeline-client:${{ needs.build.outputs.frontend-version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/familytimeline-client:${{ needs.build.outputs.frontend-version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/familytimeline-client:latest
